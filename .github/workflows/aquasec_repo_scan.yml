name: AquaSec Full Repository Scan

on:
  workflow_dispatch:
  pull_request:
    types: [ opened, synchronize ]

permissions:
  contents: read
  issues: write
  pull-requests: write
  security-events: write

concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

jobs:
  aquasec:
    name: AquaSec Full Repository Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Retrieve AquaSec Scan Results
        env:
          AQUA_KEY: ${{ secrets.AQUA_KEY }}
          AQUA_SECRET: ${{ secrets.AQUA_SECRET }}
          REPOSITORY_ID: ${{ secrets.AQUA_REPOSITORY_ID }}
        run: |
          set -euo pipefail
          
          echo "=== Authenticating with AquaSec ==="
          METHOD="POST"
          AUTH_ENDPOINT="https://eu-1.api.cloudsploit.com/v2/tokens"
          TIMESTAMP=$(date -u +%s)
          POST_BODY='{"group_id":1228,"allowed_endpoints":["GET"],"validity":240}'
          STRING_TO_SIGN="${TIMESTAMP}${METHOD}/v2/tokens${POST_BODY}"
          SIGNATURE=$(echo -n "$STRING_TO_SIGN" | openssl dgst -sha256 -hmac "${AQUA_SECRET}" -hex | sed 's/.*= //g')

          AUTH_RESPONSE=$(curl -s -X $METHOD "$AUTH_ENDPOINT" \
            -H "Content-Type: application/json" \
            -H "X-API-Key: $AQUA_KEY" \
            -H "X-Timestamp: $TIMESTAMP" \
            -H "X-Signature: $SIGNATURE" \
            -d "$POST_BODY")
          
          RESPONSE_STATUS=$(echo "$AUTH_RESPONSE" | jq -r '.status')
          
          if [ "$RESPONSE_STATUS" = "200" ]; then
            echo "Login successful."
            BEARER_TOKEN=$(echo "$AUTH_RESPONSE" | jq -r '.data')
          else
            echo "Login failed with error message: $(echo "$AUTH_RESPONSE" | jq -r '.errors')"
            exit 1
          fi
          
          echo "=== Receiving AquaSec Scan Results ==="
          
          SCAN_RESULTS_ENDPOINT="https://eu-1.codesec.aquasec.com/api/v1/scans/results"
          ALL_DATA="[]"
          PAGE_NUM=1
          PAGE_SIZE=100
          TOTAL_EXPECTED=0
          
          while true; do
            echo "Fetching page $PAGE_NUM..."
          
            REQUEST_URL="${SCAN_RESULTS_ENDPOINT}?repositoryIds=${REPOSITORY_ID}&size=${PAGE_SIZE}&page=${PAGE_NUM}"
          
            PAGE_RESPONSE=$(curl -s -X GET "$REQUEST_URL" \
              -H "Authorization: Bearer $BEARER_TOKEN" \
              -H "Accept: application/json")
          
            if [ -z "$PAGE_RESPONSE" ]; then
              echo "Failed to retrieve scan results on page $PAGE_NUM"
              exit 1
            fi
          
            if [ $PAGE_NUM -eq 1 ]; then
              TOTAL_EXPECTED=$(echo "$PAGE_RESPONSE" | jq -r '.total // 0')
              echo "Total findings expected: $TOTAL_EXPECTED"
            fi
          
            PAGE_DATA=$(echo "$PAGE_RESPONSE" | jq -c '.data // []')
            PAGE_COUNT=$(echo "$PAGE_DATA" | jq 'length')
            echo "Retrieved $PAGE_COUNT findings on page $PAGE_NUM"
          
            ALL_DATA=$(echo "$ALL_DATA" "$PAGE_DATA" | jq -s 'add')
          
            TOTAL_RETRIEVED=$(echo "$ALL_DATA" | jq 'length')
          
            if [ "$TOTAL_RETRIEVED" -ge "$TOTAL_EXPECTED" ] || [ "$PAGE_COUNT" -eq 0 ]; then
              break
            fi
          
            PAGE_NUM=$((PAGE_NUM + 1))
            sleep 2
          done
          
          TOTAL_RETRIEVED=$(echo "$ALL_DATA" | jq 'length')
          echo "Total findings retrieved: $TOTAL_RETRIEVED"
          
          jq -n --argjson total "$TOTAL_RETRIEVED" --argjson data "$ALL_DATA" \
            '{"total": $total, "size": $total, "page": 1, "data": $data}' > aquasec_scan_results.json
          
          echo "Full repository scan retrieved successfully"

      - name: Convert to SARIF 2.1.0
        shell: python
        run: |
          import json
          
          print("=== Converting Scan Result to SARIF Format ===")
          
          # Severity mapping: SARIF level, security-severity, severity tag
          SEVERITY_MAP = {
              1: ("note", "2.0", "LOW"),
              2: ("warning", "5.5", "MEDIUM"),
              3: ("error", "8.0", "HIGH"),
              4: ("error", "9.5", "CRITICAL"),
          }
          
          # Truncate text to follow with GitHub SARIF field limits
          def truncate(text, max_len=1024):
              if not text:
                  return "Security issue detected"
              return text[:max_len] if len(text) > max_len else text

          with open("aquasec_scan_results.json", "r") as f:
              data = json.load(f)
          
          aquasec_findings = data.get("data", [])
          rule_index_lookup = {}
          sarif_unique_rules = []
          sarif_findings = []
          
          for finding in aquasec_findings:
              target_file = finding.get("target_file", "")
              avd_id = finding.get("avd_id", "")
              severity = finding.get("severity", 1)
              level, sec_severity, sev_tag = SEVERITY_MAP.get(severity, SEVERITY_MAP[1])
              title = finding.get("title", "")
              message = finding.get("message", "")
              extra = finding.get("extraData", {})
              category = finding.get("category", "")
          
              if avd_id not in rule_index_lookup:
                  tags = [category, "security", sev_tag]
                  
                  refs = extra.get("references", [])
                  remediation = extra.get("remediation", "")
                  
                  rule = {
                      "id": avd_id,
                      "name": category,
                      "shortDescription": {"text": truncate(title)},
                      "fullDescription": {"text": truncate(message)},
                      "defaultConfiguration": {"level": level},
                      "help": {
                          "text": truncate(remediation),
                          "markdown": f"**{category} {avd_id}**\n| Severity | Check | Message |\n| --- | --- | --- |\n|{sev_tag}|{truncate(title, 100)}|{truncate(message, 200)}|"
                      },
                      "properties": {
                          "precision": "very-high",
                          "security-severity": sec_severity,
                          "tags": tags
                      }
                  }
                  
                  if refs:
                      rule["helpUri"] = refs[0]
                  
                  rule_index_lookup[avd_id] = len(sarif_unique_rules)
                  sarif_unique_rules.append(rule)
              
              # Sanitize security finding line numbers to please SARIF schema
              start_line = finding.get("target_start_line")
              if not start_line or start_line < 1:
                  start_line = 1
              end_line = finding.get("target_end_line")
              if not end_line or end_line < start_line:
                  end_line = start_line
              
              sarif_finding = {
                  "ruleId": avd_id,
                  "ruleIndex": rule_index_lookup[avd_id],
                  "level": level,
                  "message": {"text": truncate(message)},
                  "locations": [{
                      "physicalLocation": {
                          "artifactLocation": {"uri": target_file},
                          "region": {"startLine": start_line, "endLine": end_line}
                      }
                  }]
              }
              
              # Add finding unique hash for cross-scan deduplication
              finding_hash = finding.get("result_hash")
              if finding_hash:
                  sarif_finding["partialFingerprints"] = {"primaryLocationLineHash": finding_hash[:64]}
              
              sarif_findings.append(sarif_finding)
          
          sarif_output = {
              "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/main/sarif-2.1/schema/sarif-schema-2.1.0.json",
              "version": "2.1.0",
              "runs": [{
                  "tool": {
                      "driver": {
                          "fullName": "AquaSec Security Scanner",
                          "informationUri": "https://www.aquasec.com/",
                          "name": "AquaSec",
                          "version": "1.0.0",
                          "rules": sarif_unique_rules
                      }
                  },
                  "results": sarif_findings
              }]
          }
          
          with open("aquasec_scan.sarif", "w") as f:
              json.dump(sarif_output, f)
          
          print(f"Converted {len(sarif_findings)} findings to SARIF 2.1.0 format")

      - name: Upload Scan Results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: aquasec_scan.sarif
          category: aquasec
